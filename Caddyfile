# global options
{
    admin off # theres no need for the admin api in railway's environment
    persist_config off # storage isn't persistent anyway
    auto_https off # railway handles https for us, this could in some cases cause issues if left enabled
    # runtime logs
    log {
        format json # set runtime log format to json mode
    }
    # server options
    servers {
        trusted_proxies static private_ranges # trust railway's proxy
    }
}

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# site block, listens on the $PORT environment variable, automatically assigned by railway
:{$PORT} {
    # access logs
    log {
        format json # set access log format to json mode
    }
    
    # ðŸ“¦ COMPRESSION
    encode gzip zstd
    
    # ðŸ”§ ACTUATOR
    handle /actuator* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN:backend.railway.internal}
                port {$BACKEND_PORT:8080}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
            header_up X-Real-IP {http.request.header.CF-Connecting-IP}
            header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
        }
    }
    
    # ðŸ”¥ BACKEND API
    handle /api/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN:backend.railway.internal}
                port {$BACKEND_PORT:8080}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
            header_up X-Real-IP {http.request.header.CF-Connecting-IP}
            header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
        }
    }
    
    # ðŸŽ¨ FRONTEND - Catch-all
    handle {
        header {
            X-Frame-Options "DENY"
            X-Content-Type-Options "nosniff"
            Referrer-Policy "strict-origin-when-cross-origin"
            -Server
        }
        
        reverse_proxy {
            dynamic a {
                name {$FRONTEND_DOMAIN:frontend.railway.internal}
                port {$FRONTEND_PORT:3000}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
            header_up X-Real-IP {http.request.header.CF-Connecting-IP}
            header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
        }
    }
}
